<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동물범주형유창성검사 채점기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        /* 성별 버튼과 높이를 맞춘 입력 필드 */
        .aligned-input {
            height: 46px; /* 성별 토글 버튼과 동일한 높이 (padding 10px + font-size 16px + border 2px) */
            padding: 10px;
            box-sizing: border-box;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .time-section {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .time-section h3 {
            color: #666;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .response-tag {
            display: inline-block;
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            position: relative;
        }
        
        .response-tag .remove {
            margin-left: 10px;
            cursor: pointer;
            color: #d32f2f;
            font-weight: bold;
        }
        
        .calculate-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            background-color: #28a745;
        }
        
        .calculate-btn:hover {
            background-color: #218838;
        }
        
        .db-manage-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            background-color: #1976d2;
        }
        
        .db-manage-btn:hover {
            background-color: #1565c0;
        }
        
        .csv-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            background-color: #17a2b8;
        }
        
        .csv-btn:hover {
            background-color: #138496;
        }
        
        /* CSV 업로드 스타일 */
        .csv-upload-section {
            background-color: #e8f5f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #17a2b8;
            display: none;
        }
        
        .csv-format-example {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        
        .csv-results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .csv-result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .csv-result-table th,
        .csv-result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .csv-result-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .score-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .score-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .score-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: normal;
        }
        
        .score-card .score {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .analysis-section {
            background-color: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .response-list {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        
        .response-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .response-item:last-child {
            border-bottom: none;
        }
        
        .response-categories {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
        
        .cluster-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .category-tag {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 12px;
            font-size: 12px;
            color: #1565c0;
        }
        
        .category-info {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .used-categories {
            margin-top: 8px;
        }
        
        .algorithm-info {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .algorithm-info h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .switching-detail {
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .switching-item {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
            margin: 2px 0;
        }
        
        .switching-item.has-switch {
            background-color: #ffebee;
            border-left-color: #ff5722;
        }
        
        .switching-arrow {
            color: #ff5722;
            font-weight: bold;
            font-size: 18px;
        }
        
        .no-switch {
            color: #666;
        }
        
        .switch-marker {
            background-color: #ff5722;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .switching-detail h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .animal-number {
            font-weight: bold;
            color: #1976d2;
            min-width: 100px;
        }
        
        .shared-categories {
            margin-left: 40px;
            font-size: 12px;
            color: #4caf50;
            margin-top: 2px;
        }
        
        .no-shared-categories {
            margin-left: 40px;
            font-size: 12px;
            color: #f44336;
            margin-top: 2px;
        }
        
        /* 데이터베이스 관리 스타일 */
        .database-management {
            background-color: #f0f7ff;
            border: 2px solid #1976d2;
            padding-top: 30px;
        }
        
        .db-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }
        
        .db-controls input[type="text"] {
            width: 300px;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #1976d2;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background-color: #1565c0;
        }
        
        .btn-success {
            background-color: #4caf50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-success:hover {
            background-color: #45a049;
        }
        
        .btn-secondary {
            background-color: #757575;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #616161;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-edit {
            background-color: #ff9800;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .btn-edit:hover {
            background-color: #f57c00;
        }
        
        .animal-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .category-checkboxes {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .category-checkboxes h4 {
            margin: 10px 0 5px 0;
            color: #555;
            font-size: 16px;
        }
        
        .category-checkboxes label {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .category-checkboxes input[type="checkbox"] {
            margin-right: 5px;
        }
        
        .form-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .database-view {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .db-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            align-items: center;
            justify-content: space-between;
        }
        
        .db-stats-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
        }
        
        .db-stats span {
            font-size: 14px;
            color: #666;
        }
        
        .db-stats strong {
            color: #1976d2;
            font-size: 16px;
        }
        
        .animal-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .animal-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .animal-item:hover {
            background-color: #f0f0f0;
        }
        
        .animal-info {
            width: 100%;
        }
        
        .animal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .animal-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        
        .animal-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .category-check {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .category-check.checked {
            background-color: #e3f2fd;
            border-color: #90caf9;
            font-weight: bold;
        }
        
        .category-check input[type="checkbox"] {
            width: auto;
            margin: 0;
            pointer-events: none;
        }
        
        .search-highlight {
            background-color: yellow;
            font-weight: bold;
        }
        
        /* 성별 토글 스타일 */
        .gender-toggle {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        
        .gender-toggle input[type="radio"] {
            display: none;
        }
        
        .gender-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: normal;
        }
        
        .gender-toggle input[type="radio"]:checked + .gender-option {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }
        
        .gender-option:hover {
            background-color: #e9ecef;
        }
        
        .gender-toggle input[type="radio"]:checked + .gender-option:hover {
            background-color: #0056b3;
        }
        
        /* 점수 계산 상세 테이블 스타일 */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .detail-table th,
        .detail-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .detail-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .detail-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .detail-table td.intrusion {
            color: #f44336;
            font-weight: bold;
        }
        
        .detail-table td.perseveration {
            color: #ff9800;
            font-weight: bold;
        }
        
        .detail-table td.valid {
            color: #4caf50;
        }
        
        .detail-table td.switch {
            color: #2196f3;
            font-weight: bold;
        }
        
        /* 변형 명칭 관리 스타일 */
        .variants-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .variants-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .variant-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .variant-input-group input {
            flex: 1;
        }
        
        .variants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .variant-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 15px;
            font-size: 14px;
            border: 1px solid #90caf9;
        }
        
        .variant-remove {
            cursor: pointer;
            color: #d32f2f;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
        }
        
        .variant-remove:hover {
            background-color: #d32f2f;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>동물범주형유창성검사 채점기</h1>
        
        <div class="section">
            <div class="info-grid">
                <div class="form-group">
                    <label for="subjectId">ID</label>
                    <input type="text" id="subjectId" placeholder="피검자 ID" class="aligned-input">
                </div>
                <div class="form-group">
                    <label for="gender">성별</label>
                    <div class="gender-toggle">
                        <input type="radio" id="gender-male" name="gender" value="male">
                        <label for="gender-male" class="gender-option">남성</label>
                        <input type="radio" id="gender-female" name="gender" value="female">
                        <label for="gender-female" class="gender-option">여성</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="age">연령</label>
                    <input type="number" id="age" placeholder="연령" class="aligned-input">
                </div>
                <div class="form-group">
                    <label for="education">학력 (년)</label>
                    <input type="number" id="education" placeholder="교육년수 입력" class="aligned-input">
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="time-section">
                <h3>0-15초 구간</h3>
                <div class="input-group">
                    <input type="text" id="input-0-15" placeholder="동물 이름 입력" onkeypress="handleKeyPress(event, '0-15')">
                    <button onclick="addResponse('0-15')">추가</button>
                </div>
                <div id="responses-0-15" class="responses"></div>
            </div>
            
            <div class="time-section">
                <h3>15-30초 구간</h3>
                <div class="input-group">
                    <input type="text" id="input-15-30" placeholder="동물 이름 입력" onkeypress="handleKeyPress(event, '15-30')">
                    <button onclick="addResponse('15-30')">추가</button>
                </div>
                <div id="responses-15-30" class="responses"></div>
            </div>
            
            <div class="time-section">
                <h3>30-45초 구간</h3>
                <div class="input-group">
                    <input type="text" id="input-30-45" placeholder="동물 이름 입력" onkeypress="handleKeyPress(event, '30-45')">
                    <button onclick="addResponse('30-45')">추가</button>
                </div>
                <div id="responses-30-45" class="responses"></div>
            </div>
            
            <div class="time-section">
                <h3>45-60초 구간</h3>
                <div class="input-group">
                    <input type="text" id="input-45-60" placeholder="동물 이름 입력" onkeypress="handleKeyPress(event, '45-60')">
                    <button onclick="addResponse('45-60')">추가</button>
                </div>
                <div id="responses-45-60" class="responses"></div>
            </div>
        </div>
        
        <div class="button-group">
            <button class="calculate-btn" onclick="calculateScores()">점수 계산하기</button>
            <button class="db-manage-btn" onclick="showDatabaseManagement()">동물 데이터베이스 관리</button>
            <button class="csv-btn" onclick="showCSVUpload()">CSV 일괄 처리</button>
        </div>
        
        <div id="results" class="results">
            <h2>검사 결과</h2>
            
            
            <!-- 첫번째 줄: 총점, 전반점수, 후반점수, 보속, 침투 -->
            <div class="score-grid">
                <div class="score-card">
                    <h4>총점<br>(Total Score)</h4>
                    <div class="score" id="totalScore">0</div>
                </div>
                <div class="score-card">
                    <h4>전반점수<br>(First Half Score)</h4>
                    <div class="score" id="firstHalfScore">0</div>
                </div>
                <div class="score-card">
                    <h4>후반점수<br>(Second Half Score)</h4>
                    <div class="score" id="secondHalfScore">0</div>
                </div>
                <div class="score-card">
                    <h4>보속<br>(Perseveration)</h4>
                    <div class="score" id="perseverationScore">0</div>
                </div>
                <div class="score-card">
                    <h4>침투<br>(Intrusion)</h4>
                    <div class="score" id="intrusionScore">0</div>
                </div>
            </div>
            
            <!-- 두번째 줄: 범주수, 평균범주크기, 최대범주크기, 전환, 비효율전환 -->
            <div class="score-grid">
                <div class="score-card">
                    <h4>범주수<br>(Number of Cluster)</h4>
                    <div class="score" id="categoryScore">0</div>
                </div>
                <div class="score-card">
                    <h4>평균범주크기<br>(Mean Size of Cluster)</h4>
                    <div class="score" id="avgClusterSize">0</div>
                </div>
                <div class="score-card">
                    <h4>최대범주크기<br>(Max Size of Cluster)</h4>
                    <div class="score" id="maxClusterSize">0</div>
                </div>
                <div class="score-card">
                    <h4>전환<br>(Switching)</h4>
                    <div class="score" id="switchingScore">0</div>
                </div>
                <div class="score-card">
                    <h4>비효율전환<br>(Inefficient Switching)</h4>
                    <div class="score" id="inefficientSwitchingScore">0</div>
                </div>
            </div>
            
            <div class="analysis-section">
                <h3>점수 계산 상세 과정</h3>
                <div id="switchingAnalysis"></div>
            </div>
            
            <div class="analysis-section">
                <h3>클러스터 및 범주 분석</h3>
                <div id="clusterAnalysis"></div>
            </div>
            
        </div>
        
        <!-- 동물 데이터베이스 관리 섹션 -->
        <div class="section database-management" style="display: none; margin-top: 120px;">
            <div class="db-controls">
                <label style="font-weight: bold; margin-right: 10px;">검색</label>
                <input type="text" id="searchAnimal" placeholder="동물 검색..." onkeyup="searchAnimals()">
                <button onclick="closeDatabaseManagement()" class="btn-secondary">닫기</button>
            </div>
            
            <!-- 동물 추가/수정 폼 -->
            <div id="animalForm" style="display: none;" class="animal-form">
                <h3 id="formTitle">새 동물 추가</h3>
                <div class="form-group">
                    <label>동물 이름:</label>
                    <input type="text" id="animalName" required>
                </div>
                
                <div class="category-checkboxes">
                    <h4>생물학적 분류</h4>
                    <label><input type="checkbox" id="cat_MAMMAL"> 포유류</label>
                    <label><input type="checkbox" id="cat_BIRD"> 조류</label>
                    <label><input type="checkbox" id="cat_REPTILE"> 파충류</label>
                    <label><input type="checkbox" id="cat_AMPHIBIAN"> 양서류</label>
                    <label><input type="checkbox" id="cat_FISH"> 어류</label>
                    <label><input type="checkbox" id="cat_INSECT"> 곤충</label>
                    <label><input type="checkbox" id="cat_MOLLUSK"> 연체동물</label>
                    <label><input type="checkbox" id="cat_CRUSTACEAN"> 갑각류</label>
                    
                    <h4>서식지 분류</h4>
                    <label><input type="checkbox" id="cat_AQUATIC"> 수중생물</label>
                    <label><input type="checkbox" id="cat_MARINE"> 해양생물</label>
                    <label><input type="checkbox" id="cat_FRESHWATER"> 담수생물</label>
                    <label><input type="checkbox" id="cat_AERIAL"> 비행동물</label>
                    
                    <h4>인간과의 관계</h4>
                    <label><input type="checkbox" id="cat_DOMESTIC"> 가축</label>
                    <label><input type="checkbox" id="cat_PET"> 애완동물</label>
                    <label><input type="checkbox" id="cat_WILD"> 야생동물</label>
                    
                    <h4>문화적 분류</h4>
                    <label><input type="checkbox" id="cat_ZODIAC"> 12간지</label>
                    <label><input type="checkbox" id="cat_MYTHOLOGY"> 신화동물</label>
                    <label><input type="checkbox" id="cat_IMAGINARY"> 상상의 동물</label>
                    <label><input type="checkbox" id="cat_PREHISTORIC"> 선사시대 동물</label>
                </div>
                
                <!-- 변형 명칭 관리 섹션 -->
                <div class="variants-section">
                    <h4>변형 명칭 관리</h4>
                    <p class="variants-description">이 동물의 다른 표현들 (성별, 연령, 사투리 등)을 관리합니다. 예: 개 → 강아지, 멍멍이, 암캐, 수캐</p>
                    
                    <div class="variant-input-group">
                        <input type="text" id="variantInput" placeholder="변형 명칭 입력 (예: 강아지, 멍멍이)">
                        <button type="button" onclick="addVariant()" class="btn-secondary">추가</button>
                    </div>
                    
                    <div id="variantsList" class="variants-list">
                        <!-- 변형 명칭들이 여기에 표시됩니다 -->
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button onclick="saveAnimal()" class="btn-primary">저장</button>
                    <button onclick="cancelAnimalForm()" class="btn-secondary">취소</button>
                </div>
            </div>
            
            <!-- 데이터베이스 목록 -->
            <div id="databaseView" class="database-view">
                <div class="db-stats">
                    <div class="db-stats-info">
                        <span>총 동물 수: <strong id="totalAnimals">0</strong></span>
                        <span>포유류: <strong id="mammalCount">0</strong></span>
                        <span>조류: <strong id="birdCount">0</strong></span>
                        <span>파충류: <strong id="reptileCount">0</strong></span>
                        <span>양서류: <strong id="amphibianCount">0</strong></span>
                        <span>어류: <strong id="fishCount">0</strong></span>
                        <span>곤충: <strong id="insectCount">0</strong></span>
                        <span>연체동물: <strong id="molluskCount">0</strong></span>
                        <span>갑각류: <strong id="crustaceanCount">0</strong></span>
                    </div>
                    <button onclick="showAddAnimalForm()" class="btn-success">새 동물 추가</button>
                </div>
                
                <div id="animalList" class="animal-list"></div>
            </div>
        </div>
        
        <!-- CSV 일괄 처리 섹션 -->
        <div class="csv-upload-section" id="csvUploadSection">
            <h2>CSV 일괄 처리</h2>
            
            <div class="csv-format-info">
                <h3>CSV 파일 형식</h3>
                <p>다음 형식으로 CSV 파일을 준비해주세요:</p>
                <div class="csv-format-example">
ID,성별,연령,학력,0-15초,15-30초,30-45초,45-60초
001,남성,65,12,개,고양이,소,말,돼지,닭,호랑이,사자,뱀,거북이
002,여성,72,6,개,소,말,닭,오리,개구리,토끼,쥐
003,남성,58,16,사자,호랑이,표범,치타,고양이,개,늑대,여우,너구리,곰,판다
                </div>
                <p><strong>주의사항:</strong></p>
                <ul>
                    <li>첫 번째 줄은 반드시 헤더로 위와 같이 작성</li>
                    <li>각 시간대별 동물은 쉼표(,)로 구분</li>
                    <li>성별은 "남성" 또는 "여성"으로 입력</li>
                    <li>UTF-8 인코딩으로 저장</li>
                </ul>
            </div>
            
            <div class="csv-upload-area">
                <input type="file" id="csvFile" accept=".csv" style="margin: 20px 0;">
                <button onclick="processCSV()" class="btn-primary">CSV 처리하기</button>
                <button onclick="downloadCSVTemplate()" class="btn-secondary">템플릿 다운로드</button>
                <button onclick="hideCSVUpload()" class="btn-secondary">닫기</button>
            </div>
            
            <div id="csvResults" class="csv-results"></div>
        </div>
    </div>
    
    <!-- 외부 동물 데이터베이스 참조 -->
    <script src="animal-database.js"></script>
    <script src="animal-variants.js"></script>
    
    <script>
        // 전역 변수로 반응 저장
        const responses = {
            '0-15': [],
            '15-30': [],
            '30-45': [],
            '45-60': []
        };
        
        // 범주 정의 (수정된 버전)
        const CATEGORIES = {
            // 생물학적 분류
            MAMMAL: '포유류',
            BIRD: '조류',
            REPTILE: '파충류',
            AMPHIBIAN: '양서류',
            FISH: '어류',
            INSECT: '곤충',
            MOLLUSK: '연체동물',
            CRUSTACEAN: '갑각류',
            
            // 서식지별 분류 (육상동물 제외)
            AQUATIC: '수생동물',
            MARINE: '해양동물',
            FRESHWATER: '담수동물',
            AERIAL: '비행동물',
            
            // 인간과의 관계
            DOMESTIC: '가축',
            PET: '애완동물',
            WILD: '야생동물',
            
            // 문화적 분류 (멸종위기 제외)
            ZODIAC: '12간지',
            MYTHOLOGY: '신화동물',
            IMAGINARY: '상상의 동물',
            PREHISTORIC: '선사시대 동물'
        };
        
        // 동물 데이터베이스는 외부 파일(animal-database.js)에서 로드됨
        // 특정 동물의 모든 범주 가져오기
        function getAnimalCategories(animalName) {
            // 변형 명칭을 기본 명칭으로 정규화
            const normalizedName = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(animalName) : animalName;
            const animalData = ANIMAL_CATEGORIES[normalizedName || animalName];
            if (!animalData) return [];
            
            const categories = [];
            for (const [cat, value] of Object.entries(animalData)) {
                if (value === true && CATEGORIES[cat]) {
                    categories.push({
                        code: cat,
                        name: CATEGORIES[cat]
                    });
                }
            }
            return categories;
        }
        
        // 특정 동물의 주요 생물학적 범주 가져오기 (클러스터 분석용)
        function getPrimaryBiologicalCategory(animalName) {
            // 변형 명칭을 기본 명칭으로 정규화
            const normalizedName = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(animalName) : animalName;
            const animalData = ANIMAL_CATEGORIES[normalizedName || animalName];
            if (!animalData) return '기타';
            
            // 생물학적 분류 우선순위
            const biologicalCategories = ['MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN'];
            
            for (const bioCategory of biologicalCategories) {
                if (animalData[bioCategory] === true) {
                    return CATEGORIES[bioCategory];
                }
            }
            
            // 신화동물인 경우
            if (animalData['MYTHOLOGY'] === true) {
                return CATEGORIES['MYTHOLOGY'];
            }
            
            return '기타';
        }
        
        // 공통 범주 기반 전환 분석 알고리즘
        function analyzeTransitionsAndClusters(responses) {
            console.log('=== 전환 분석 시작 ===');
            console.log('입력된 동물들:', responses.map(r => r.normalizedResponse));
            
            if (responses.length === 0) return { transitions: [], clusters: [], switchingScore: 0 };
            
            const transitions = [];
            const clusters = [];
            let switchingScore = 0;
            let currentCluster = null;
            
            for (let i = 0; i < responses.length; i++) {
                const originalAnimal = responses[i].normalizedResponse;
                // 변형 명칭을 기본 명칭으로 정규화
                const normalizedAnimal = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(originalAnimal) : originalAnimal;
                const animal = normalizedAnimal || originalAnimal;
                const animalData = ANIMAL_CATEGORIES[animal] || {};
                
                console.log(`\n--- ${i+1}번째 동물: ${originalAnimal}${normalizedAnimal !== originalAnimal ? ` → ${normalizedAnimal}` : ''} ---`);
                
                // 동물의 true인 카테고리들만 추출
                const categories = [];
                for (const [cat, value] of Object.entries(animalData)) {
                    if (value === true) {
                        categories.push(cat);
                    }
                }
                console.log(`${animal}의 범주:`, categories.map(cat => CATEGORIES[cat] || cat));
                
                if (i === 0) {
                    // 첫 번째 동물
                    console.log('첫 번째 동물 - 클러스터 시작');
                    currentCluster = {
                        startIndex: 0,
                        animals: [animal],
                        sharedCategories: [...categories],
                        allCategories: new Set(categories)
                    };
                    
                    transitions.push({
                        index: i + 1,
                        animal: animal,
                        categories: categories,
                        isSwitch: false,
                        reason: '시작',
                        sharedWithPrev: null
                    });
                } else {
                    const prevAnimal = responses[i-1].normalizedResponse;
                    const prevAnimalData = ANIMAL_CATEGORIES[prevAnimal] || {};
                    
                    // 현재 클러스터의 공유 범주와 비교
                    // (이전 동물의 모든 범주가 아니라, 현재 클러스터가 공유하는 범주와 비교)
                    console.log(`현재 클러스터의 공유 범주:`, currentCluster.sharedCategories.map(cat => CATEGORIES[cat] || cat));
                    
                    // 공통 범주 찾기 - 현재 동물과 현재 클러스터의 공유 범주 간의 교집합
                    const sharedCategories = categories.filter(cat => currentCluster.sharedCategories.includes(cat));
                    console.log('현재 동물과 클러스터의 공통 범주:', sharedCategories.map(cat => CATEGORIES[cat] || cat));
                    
                    if (sharedCategories.length > 0) {
                        // 공통 범주가 있음 - 전환 아님
                        console.log('→ 전환 아님 (공통 범주 있음)');
                        currentCluster.animals.push(animal);
                        categories.forEach(cat => currentCluster.allCategories.add(cat));
                        
                        // 클러스터의 공통 범주 업데이트 (교집합)
                        currentCluster.sharedCategories = currentCluster.sharedCategories.filter(
                            cat => categories.includes(cat)
                        );
                        
                        transitions.push({
                            index: i + 1,
                            animal: animal,
                            categories: categories,
                            isSwitch: false,
                            reason: '공통 범주 있음',
                            sharedWithPrev: sharedCategories
                        });
                    } else {
                        // 공통 범주가 없음 - 전환!
                        switchingScore++;
                        console.log(`→ 전환 발생! (전환 #${switchingScore})`);
                        
                        // 이전 클러스터 저장
                        console.log(`이전 클러스터 저장: ${currentCluster.animals.join(', ')}`);
                        clusters.push({
                            ...currentCluster,
                            endIndex: i - 1,
                            size: currentCluster.animals.length
                        });
                        
                        // 새 클러스터 시작
                        console.log(`새 클러스터 시작: ${animal}`);
                        currentCluster = {
                            startIndex: i,
                            animals: [animal],
                            sharedCategories: [...categories],
                            allCategories: new Set(categories)
                        };
                        
                        transitions.push({
                            index: i + 1,
                            animal: animal,
                            categories: categories,
                            isSwitch: true,
                            reason: '공통 범주 없음',
                            sharedWithPrev: [],
                            switchNumber: switchingScore
                        });
                    }
                }
            }
            
            // 마지막 클러스터 저장
            if (currentCluster) {
                console.log(`마지막 클러스터 저장: ${currentCluster.animals.join(', ')}`);
                clusters.push({
                    ...currentCluster,
                    endIndex: responses.length - 1,
                    size: currentCluster.animals.length
                });
            }
            
            console.log('\n=== 전환 분석 결과 ===');
            console.log(`총 전환 횟수: ${switchingScore}`);
            console.log(`클러스터 수: ${clusters.length}`);
            console.log('클러스터 구성:');
            clusters.forEach((cluster, idx) => {
                console.log(`  클러스터 ${idx + 1}: ${cluster.animals.join(', ')} (크기: ${cluster.size})`);
            });
            
            return { transitions, clusters, switchingScore };
        }
        
        function handleKeyPress(event, timeRange) {
            if (event.key === 'Enter') {
                addResponse(timeRange);
            }
        }
        
        function addResponse(timeRange) {
            const input = document.getElementById(`input-${timeRange}`);
            const value = input.value.trim();
            
            if (value) {
                responses[timeRange].push(value);
                input.value = '';
                displayResponses(timeRange);
            }
        }
        
        function removeResponse(timeRange, index) {
            responses[timeRange].splice(index, 1);
            displayResponses(timeRange);
        }
        
        function displayResponses(timeRange) {
            const container = document.getElementById(`responses-${timeRange}`);
            container.innerHTML = responses[timeRange]
                .map((response, index) => 
                    `<span class="response-tag">
                        ${response}
                        <span class="remove" onclick="removeResponse('${timeRange}', ${index})">×</span>
                    </span>`
                ).join('');
        }
        
        function calculateScores() {
            console.log('calculateScores 함수 시작');
            
            try {
                // 모든 반응을 순서대로 정리
                const allResponses = [];
                let order = 1;
            
            ['0-15', '15-30', '30-45', '45-60'].forEach(range => {
                console.log(`Processing range ${range}:`, responses[range]);
                responses[range].forEach(response => {
                    // 변형 명칭을 기본 명칭으로 정규화
                    const trimmed = response.trim();
                    const normalized = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(trimmed) : null;
                    
                    // normalized가 null이면 데이터베이스에 없는 단어
                    // ANIMAL_CATEGORIES에서 직접 확인
                    const finalNormalized = normalized || (ANIMAL_CATEGORIES[trimmed] ? trimmed : null);
                    
                    allResponses.push({
                        response: response,
                        normalizedResponse: finalNormalized,
                        originalResponse: trimmed,
                        order,
                        timeRange: range
                    });
                    order++;
                });
            });
            
            if (allResponses.length === 0) {
                alert('반응을 입력해주세요.');
                return;
            }
            
            // 1. Total Score (중복 제외, 침투 반응 제외)
            const validResponses = allResponses.filter(r => r.normalizedResponse !== null);
            const uniqueResponses = [...new Set(validResponses.map(r => r.normalizedResponse))];
            const totalScore = uniqueResponses.length;
            
            // 2. First Half Score (침투 제외, 중복 제외)
            const firstHalfResponses = allResponses.filter(r => 
                (r.timeRange === '0-15' || r.timeRange === '15-30') && r.normalizedResponse !== null
            );
            const firstHalfScore = new Set(firstHalfResponses.map(r => r.normalizedResponse)).size;
            
            // 3. Second Half Score (침투 제외, 중복 제외)
            const secondHalfResponses = allResponses.filter(r => 
                (r.timeRange === '30-45' || r.timeRange === '45-60') && r.normalizedResponse !== null
            );
            const secondHalfScore = new Set(secondHalfResponses.map(r => r.normalizedResponse)).size;
            
            // 4. Perseveration Score (침투 반응 제외)
            const responseCount = {};
            validResponses.forEach(r => {
                responseCount[r.normalizedResponse] = (responseCount[r.normalizedResponse] || 0) + 1;
            });
            const perseverationScore = Object.values(responseCount)
                .filter(count => count > 1)
                .reduce((sum, count) => sum + (count - 1), 0);
            
            // 5. Intrusion Score (데이터베이스에 없는 동물)
            let intrusionScore = 0;
            const intrusions = [];
            allResponses.forEach(response => {
                if (response.normalizedResponse === null) {
                    intrusionScore++;
                    if (!intrusions.includes(response.response)) {
                        intrusions.push(response.response);
                    }
                }
            });
            
            // 6. 공통 범주 기반 전환 분석 (침투 반응 제외)
            console.log('analyzeTransitionsAndClusters 호출 전, validResponses:', validResponses);
            const { transitions, clusters, switchingScore } = analyzeTransitionsAndClusters(validResponses);
            console.log('analyzeTransitionsAndClusters 결과:', { transitions, clusters, switchingScore });
            
            // 7. 범주점수 (각 클러스터마다 1개의 대표 범주만 카운트, 중복 제외)
            console.log('\n=== 범주 점수 계산 ===');
            const usedCategories = new Set();
            clusters.forEach((cluster, idx) => {
                console.log(`\n클러스터 ${idx + 1} (${cluster.animals.join(', ')}):`);
                console.log('  공통 범주:', cluster.sharedCategories.map(cat => CATEGORIES[cat] || cat));
                
                // 각 클러스터의 대표 범주 결정 (가장 많이 공유된 범주 선택)
                if (cluster.sharedCategories.length > 0) {
                    // 공통 범주 중 첫 번째를 대표로 선택
                    const representativeCategory = cluster.sharedCategories[0];
                    console.log(`  → 대표 범주로 '${CATEGORIES[representativeCategory]}' 선택`);
                    usedCategories.add(representativeCategory);
                } else if (cluster.allCategories.size > 0) {
                    // 공통 범주가 없으면 첫 번째 동물의 주요 범주 선택
                    const firstAnimalCategories = [];
                    const firstAnimalData = ANIMAL_CATEGORIES[cluster.animals[0]] || {};
                    
                    // 생물학적 분류 우선
                    const biologicalCategories = ['MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN'];
                    for (const bioCategory of biologicalCategories) {
                        if (firstAnimalData[bioCategory] === true) {
                            console.log(`  → 대표 범주로 '${CATEGORIES[bioCategory]}' 선택 (첫 동물의 생물학적 분류)`);
                            usedCategories.add(bioCategory);
                            break;
                        }
                    }
                }
            });
            const categoryScore = usedCategories.size;
            console.log('\n사용된 범주들:', Array.from(usedCategories).map(cat => CATEGORIES[cat] || cat));
            console.log(`총 범주 점수: ${categoryScore}`);
            
            // 8. 클러스터 분석
            const clusterSizes = clusters.map(c => c.size);
            const avgClusterSize = clusterSizes.length > 0 
                ? clusterSizes.reduce((sum, size) => sum + size, 0) / clusterSizes.length
                : 0;
            const maxClusterSize = Math.max(...clusterSizes, 0);
            
            // 9. 비효율전환점수 (크기 1인 클러스터 수)
            let inefficientSwitchingScore = clusters.filter(c => c.size === 1).length;
            
            // 결과 표시
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('firstHalfScore').textContent = firstHalfScore;
            document.getElementById('secondHalfScore').textContent = secondHalfScore;
            document.getElementById('perseverationScore').textContent = perseverationScore;
            document.getElementById('intrusionScore').textContent = intrusionScore;
            document.getElementById('switchingScore').textContent = switchingScore;
            document.getElementById('inefficientSwitchingScore').textContent = inefficientSwitchingScore;
            document.getElementById('categoryScore').textContent = categoryScore;
            document.getElementById('avgClusterSize').textContent = avgClusterSize.toFixed(1);
            document.getElementById('maxClusterSize').textContent = maxClusterSize;
            
            // 점수 계산 상세 과정 표 표시
            const detailTableHtml = `
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>시간대</th>
                            <th>반응 단어</th>
                            <th>반응 유형</th>
                            <th>전환 여부</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generateDetailTableRows()}
                    </tbody>
                </table>
            `;
            
            // 상세 테이블 행 생성 함수
            function generateDetailTableRows() {
                const timeRanges = ['0-15', '15-30', '30-45', '45-60'];
                let rows = '';
                let transitionIndex = 0;
                
                // 보속 반응 추적을 위한 맵
                const seenAnimals = new Map();
                allResponses.forEach((response, idx) => {
                    if (response.normalizedResponse !== null) {
                        if (!seenAnimals.has(response.normalizedResponse)) {
                            seenAnimals.set(response.normalizedResponse, []);
                        }
                        seenAnimals.get(response.normalizedResponse).push(idx);
                    }
                });
                
                timeRanges.forEach(range => {
                    const rangeResponses = allResponses.filter(r => r.timeRange === range);
                    if (rangeResponses.length === 0) return;
                    
                    rangeResponses.forEach((response, idx) => {
                        const isFirstInRange = idx === 0;
                        const globalIndex = allResponses.findIndex(r => r === response);
                        
                        // 반응 유형 결정
                        let responseType = '정반응';
                        if (response.normalizedResponse === null) {
                            responseType = '침투';
                        } else if (seenAnimals.get(response.normalizedResponse) && 
                                 seenAnimals.get(response.normalizedResponse).indexOf(globalIndex) > 0) {
                            responseType = '보속';
                        }
                        
                        // 전환 여부 확인
                        let transitionInfo = '';
                        let categoryInfo = '';
                        
                        // 침투 반응은 전환 분석에서 제외됨
                        if (responseType === '침투') {
                            transitionInfo = '동물에 해당하지 않음';
                        } else if (transitionIndex < transitions.length && 
                            transitions[transitionIndex].animal === response.response) {
                            const trans = transitions[transitionIndex];
                            
                            // 현재 클러스터의 공유 범주 찾기
                            const currentCluster = clusters.find(c => 
                                c.animals.some(a => a.animal === response.response)
                            );
                            
                            if (trans.isSwitch) {
                                transitionInfo = `전환 #${trans.switchNumber}`;
                                // 전환 시 전환된 첫 단어가 속한 모든 범주 표시
                                const animalData = ANIMAL_CATEGORIES[response.normalizedResponse];
                                if (animalData) {
                                    const allCategories = [];
                                    for (const [cat, value] of Object.entries(animalData)) {
                                        if (value === true) {
                                            allCategories.push(CATEGORIES[cat]);
                                        }
                                    }
                                    if (allCategories.length > 0) {
                                        categoryInfo = ` (${allCategories.join(', ')})`;
                                    }
                                }
                            } else if (trans.index === 1) {
                                transitionInfo = '시작';
                                // 시작 시 해당 동물의 모든 범주 표시
                                const animalData = ANIMAL_CATEGORIES[response.normalizedResponse];
                                if (animalData) {
                                    const allCategories = [];
                                    for (const [cat, value] of Object.entries(animalData)) {
                                        if (value === true) {
                                            allCategories.push(CATEGORIES[cat]);
                                        }
                                    }
                                    if (allCategories.length > 0) {
                                        categoryInfo = ` (${allCategories.join(', ')})`;
                                    }
                                }
                            } else {
                                transitionInfo = '유지';
                                if (trans.sharedWithPrev && trans.sharedWithPrev.length > 0) {
                                    categoryInfo = ` (${trans.sharedWithPrev.map(cat => CATEGORIES[cat]).join(', ')})`;
                                }
                            }
                            transitionIndex++;
                        }
                        
                        rows += `
                            <tr>
                                ${isFirstInRange ? `<td rowspan="${rangeResponses.length}">${range}초</td>` : ''}
                                <td>${response.order}. ${response.response}</td>
                                <td class="${responseType === '침투' ? 'intrusion' : responseType === '보속' ? 'perseveration' : 'valid'}">${responseType}</td>
                                <td class="${transitionInfo.includes('전환') ? 'switch' : ''}">${transitionInfo}${categoryInfo}</td>
                            </tr>
                        `;
                    });
                });
                
                return rows;
            }
            
            const switchingAnalysisHtml = detailTableHtml;
            document.getElementById('switchingAnalysis').innerHTML = switchingAnalysisHtml;
            
            // 클러스터 및 범주 분석 표 표시
            const clusterTableHtml = `
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>클러스터</th>
                            <th>단어 리스트</th>
                            <th>범주명</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generateClusterTableRows()}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: left; padding: 15px; background-color: #f5f5f5;">
                                <strong>클러스터 수:</strong> ${clusters.length}개 &nbsp;&nbsp;
                                <strong>평균 클러스터 크기:</strong> ${avgClusterSize.toFixed(1)}개 &nbsp;&nbsp;
                                <strong>최대 클러스터 크기:</strong> ${maxClusterSize}개<br>
                                <strong>범주수:</strong> ${categoryScore}개 &nbsp;&nbsp;
                                <strong>평균 범주크기:</strong> ${avgClusterSize.toFixed(1)}개 &nbsp;&nbsp;
                                <strong>최대 범주크기:</strong> ${maxClusterSize}개
                            </td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            // 클러스터 테이블 행 생성 함수
            function generateClusterTableRows() {
                let rows = '';
                
                clusters.forEach((cluster, idx) => {
                    const sharedCategoriesStr = cluster.sharedCategories.map(cat => CATEGORIES[cat]).join(', ') || '공통범주없음';
                    
                    // 대표 범주 결정
                    let representativeCategory = '';
                    if (cluster.sharedCategories.length > 0) {
                        representativeCategory = CATEGORIES[cluster.sharedCategories[0]];
                    } else if (cluster.animals.length > 0) {
                        const firstAnimalData = ANIMAL_CATEGORIES[cluster.animals[0]] || {};
                        const biologicalCategories = ['MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN'];
                        for (const bioCategory of biologicalCategories) {
                            if (firstAnimalData[bioCategory] === true) {
                                representativeCategory = CATEGORIES[bioCategory];
                                break;
                            }
                        }
                    }
                    
                    const animalsList = cluster.animals.join(', ');
                    
                    rows += `
                        <tr>
                            <td style="text-align: center; font-weight: bold;">클러스터 ${idx + 1}<br>(크기: ${cluster.size})</td>
                            <td>${animalsList}</td>
                            <td>
                                <strong>공유 범주:</strong> ${sharedCategoriesStr}<br>
                                <strong>대표 범주:</strong> ${representativeCategory || '없음'}
                            </td>
                        </tr>
                    `;
                });
                
                return rows;
            }
            
            document.getElementById('clusterAnalysis').innerHTML = clusterTableHtml;
            
            
            
            // 결과 섹션 표시
            document.getElementById('results').style.display = 'block';
            
            // 결과 위치로 스크롤
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
            console.log('calculateScores 함수 완료');
            
            } catch (error) {
                console.error('calculateScores 에러:', error);
                alert('점수 계산 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // =====================================================
        // 데이터베이스 관리 함수들
        // =====================================================
        
        let editingAnimal = null;
        let currentVariants = []; // 현재 편집 중인 동물의 변형 명칭들
        
        // 데이터베이스 관리 화면 표시
        function showDatabaseManagement() {
            const dbSection = document.querySelector('.database-management');
            const resultsSection = document.getElementById('results');
            
            // 결과 섹션 숨기기
            resultsSection.style.display = 'none';
            
            // 데이터베이스 관리 섹션 표시
            dbSection.style.display = 'block';
            updateDatabaseStats();
            displayAllAnimals();
            
            // 데이터베이스 관리 위치로 스크롤
            dbSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 데이터베이스 관리 화면 닫기
        function closeDatabaseManagement() {
            const dbSection = document.querySelector('.database-management');
            dbSection.style.display = 'none';
        }
        
        // 동물 추가 폼 표시
        function showAddAnimalForm() {
            editingAnimal = null;
            currentVariants = [];
            document.getElementById('formTitle').textContent = '새 동물 추가';
            document.getElementById('animalName').value = '';
            clearAllCheckboxes();
            displayVariants();
            document.getElementById('animalForm').style.display = 'block';
        }
        
        // 동물 수정 폼 표시
        function showEditAnimalForm(animalName) {
            editingAnimal = animalName;
            const animalData = ANIMAL_CATEGORIES[animalName];
            
            document.getElementById('formTitle').textContent = `'${animalName}' 수정`;
            document.getElementById('animalName').value = animalName;
            
            // 체크박스 상태 설정
            clearAllCheckboxes();
            for (const [category, value] of Object.entries(animalData)) {
                const checkbox = document.getElementById(`cat_${category}`);
                if (checkbox) {
                    checkbox.checked = value;
                }
            }
            
            // 현재 동물의 변형 명칭들 로드
            loadAnimalVariants(animalName);
            
            document.getElementById('animalForm').style.display = 'block';
        }
        
        // 모든 체크박스 초기화
        function clearAllCheckboxes() {
            const checkboxes = document.querySelectorAll('.category-checkboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // 동물 저장
        function saveAnimal() {
            const animalName = document.getElementById('animalName').value.trim();
            if (!animalName) {
                alert('동물 이름을 입력해주세요.');
                return;
            }
            
            // 중복 체크 (수정이 아닌 경우)
            if (!editingAnimal && ANIMAL_CATEGORIES[animalName]) {
                alert('이미 존재하는 동물입니다.');
                return;
            }
            
            // 카테고리 데이터 수집
            const categories = [
                'MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN',
                'AQUATIC', 'MARINE', 'FRESHWATER', 'AERIAL',
                'DOMESTIC', 'PET', 'WILD',
                'ZODIAC', 'MYTHOLOGY', 'IMAGINARY', 'PREHISTORIC'
            ];
            
            const animalData = {};
            categories.forEach(cat => {
                const checkbox = document.getElementById(`cat_${cat}`);
                animalData[cat] = checkbox ? checkbox.checked : false;
            });
            
            // 수정인 경우 기존 데이터 삭제
            if (editingAnimal && editingAnimal !== animalName) {
                delete ANIMAL_CATEGORIES[editingAnimal];
            }
            
            // 데이터 저장
            ANIMAL_CATEGORIES[animalName] = animalData;
            
            // 변형 명칭 저장 (animal-variants.js가 로드되어 있고 함수가 있는 경우)
            if (typeof animalVariants !== 'undefined' && typeof variantToBase !== 'undefined') {
                // 기존 변형 명칭들 제거 (역방향 매핑에서)
                if (editingAnimal && editingAnimal !== animalName) {
                    // 동물 이름이 변경된 경우 기존 변형들 정리
                    const oldVariants = getAnimalVariants ? getAnimalVariants(editingAnimal) : [];
                    if (oldVariants) {
                        oldVariants.forEach(variant => {
                            delete variantToBase[variant];
                        });
                    }
                    delete animalVariants[editingAnimal];
                }
                
                // 새로운 변형 명칭들 저장
                if (currentVariants.length > 0) {
                    animalVariants[animalName] = {
                        base: animalName,
                        variants: [...currentVariants]
                    };
                    
                    // 역방향 매핑 업데이트
                    currentVariants.forEach(variant => {
                        variantToBase[variant] = animalName;
                    });
                } else {
                    // 변형 명칭이 없으면 기본 엔트리만 유지
                    animalVariants[animalName] = {
                        base: animalName,
                        variants: []
                    };
                }
                
                // 기본 동물명도 자기 자신을 가리키도록 설정
                variantToBase[animalName] = animalName;
            }
            
            // 저장 알림
            alert(editingAnimal ? '동물 정보가 수정되었습니다.' : '새 동물이 추가되었습니다.');
            
            // 폼 닫기 및 목록 업데이트
            cancelAnimalForm();
            updateDatabaseStats();
            displayAllAnimals();
        }
        
        // 동물 삭제
        function deleteAnimal(animalName) {
            if (confirm(`'${animalName}'을(를) 정말 삭제하시겠습니까?`)) {
                // 동물 카테고리에서 삭제
                delete ANIMAL_CATEGORIES[animalName];
                
                // 변형 명칭들도 함께 삭제
                if (typeof animalVariants !== 'undefined' && typeof variantToBase !== 'undefined') {
                    const variants = getAnimalVariants ? getAnimalVariants(animalName) : [];
                    if (variants) {
                        variants.forEach(variant => {
                            delete variantToBase[variant];
                        });
                    }
                    delete animalVariants[animalName];
                    delete variantToBase[animalName];
                }
                
                alert('동물이 삭제되었습니다.');
                updateDatabaseStats();
                displayAllAnimals();
            }
        }
        
        // 폼 취소
        function cancelAnimalForm() {
            document.getElementById('animalForm').style.display = 'none';
            editingAnimal = null;
            currentVariants = [];
        }
        
        // =====================================================
        // 변형 명칭 관리 함수들
        // =====================================================
        
        // 현재 동물의 변형 명칭들 로드
        function loadAnimalVariants(animalName) {
            if (typeof getAnimalVariants === 'function') {
                const variants = getAnimalVariants(animalName);
                currentVariants = variants ? [...variants] : [];
            } else {
                currentVariants = [];
            }
            displayVariants();
        }
        
        // 변형 명칭 추가
        function addVariant() {
            const variantInput = document.getElementById('variantInput');
            const variant = variantInput.value.trim();
            
            if (!variant) {
                alert('변형 명칭을 입력해주세요.');
                return;
            }
            
            if (currentVariants.includes(variant)) {
                alert('이미 존재하는 변형 명칭입니다.');
                return;
            }
            
            currentVariants.push(variant);
            variantInput.value = '';
            displayVariants();
        }
        
        // 변형 명칭 제거
        function removeVariant(variant) {
            const index = currentVariants.indexOf(variant);
            if (index > -1) {
                currentVariants.splice(index, 1);
                displayVariants();
            }
        }
        
        // 변형 명칭들 표시
        function displayVariants() {
            const variantsList = document.getElementById('variantsList');
            
            if (currentVariants.length === 0) {
                variantsList.innerHTML = '<div style="color: #999; font-style: italic;">변형 명칭이 없습니다.</div>';
                return;
            }
            
            const variantsHtml = currentVariants.map(variant => `
                <div class="variant-tag">
                    <span>${variant}</span>
                    <span class="variant-remove" onclick="removeVariant('${variant}')" title="제거">×</span>
                </div>
            `).join('');
            
            variantsList.innerHTML = variantsHtml;
        }
        
        // 변형 명칭 입력 시 엔터키 처리
        document.addEventListener('DOMContentLoaded', function() {
            const variantInput = document.getElementById('variantInput');
            if (variantInput) {
                variantInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        addVariant();
                    }
                });
            }
        });
        
        // 데이터베이스 통계 업데이트
        function updateDatabaseStats() {
            const stats = {
                total: 0,
                MAMMAL: 0,
                BIRD: 0,
                REPTILE: 0,
                AMPHIBIAN: 0,
                FISH: 0,
                INSECT: 0,
                MOLLUSK: 0,
                CRUSTACEAN: 0
            };
            
            for (const [animalName, animalData] of Object.entries(ANIMAL_CATEGORIES)) {
                stats.total++;
                if (animalData.MAMMAL) stats.MAMMAL++;
                if (animalData.BIRD) stats.BIRD++;
                if (animalData.REPTILE) stats.REPTILE++;
                if (animalData.AMPHIBIAN) stats.AMPHIBIAN++;
                if (animalData.FISH) stats.FISH++;
                if (animalData.INSECT) stats.INSECT++;
                if (animalData.MOLLUSK) stats.MOLLUSK++;
                if (animalData.CRUSTACEAN) stats.CRUSTACEAN++;
            }
            
            document.getElementById('totalAnimals').textContent = stats.total;
            document.getElementById('mammalCount').textContent = stats.MAMMAL;
            document.getElementById('birdCount').textContent = stats.BIRD;
            document.getElementById('reptileCount').textContent = stats.REPTILE;
            document.getElementById('amphibianCount').textContent = stats.AMPHIBIAN;
            document.getElementById('fishCount').textContent = stats.FISH;
            document.getElementById('insectCount').textContent = stats.INSECT;
            document.getElementById('molluskCount').textContent = stats.MOLLUSK;
            document.getElementById('crustaceanCount').textContent = stats.CRUSTACEAN;
        }
        
        // 모든 동물 표시
        function displayAllAnimals() {
            const searchTerm = document.getElementById('searchAnimal').value.toLowerCase();
            const animalList = document.getElementById('animalList');
            animalList.innerHTML = '';
            
            const sortedAnimals = Object.keys(ANIMAL_CATEGORIES).sort((a, b) => a.localeCompare(b, 'ko'));
            
            sortedAnimals.forEach(animalName => {
                // 기본 이름으로 검색
                let shouldShow = false;
                
                if (!searchTerm) {
                    shouldShow = true;
                } else if (animalName.toLowerCase().includes(searchTerm)) {
                    shouldShow = true;
                } else if (typeof getAnimalVariants === 'function') {
                    // 변형 명칭으로도 검색
                    const variants = getAnimalVariants(animalName);
                    if (variants && variants.some(variant => variant.toLowerCase().includes(searchTerm))) {
                        shouldShow = true;
                    }
                }
                
                if (!shouldShow) {
                    return;
                }
                
                const animalData = ANIMAL_CATEGORIES[animalName];
                const animalItem = createAnimalItem(animalName, animalData, searchTerm);
                animalList.appendChild(animalItem);
            });
        }
        
        // 동물 항목 생성
        function createAnimalItem(animalName, animalData, searchTerm) {
            const div = document.createElement('div');
            div.className = 'animal-item';
            
            // 동물 정보
            const infoDiv = document.createElement('div');
            infoDiv.className = 'animal-info';
            
            // 헤더 (이름 + 버튼)
            const headerDiv = document.createElement('div');
            headerDiv.className = 'animal-header';
            
            // 동물 이름 (검색어 하이라이트)
            const nameDiv = document.createElement('div');
            nameDiv.className = 'animal-name';
            if (searchTerm) {
                nameDiv.innerHTML = animalName.replace(
                    new RegExp(searchTerm, 'gi'),
                    match => `<span class="search-highlight">${match}</span>`
                );
            } else {
                nameDiv.textContent = animalName;
            }
            headerDiv.appendChild(nameDiv);
            
            // 액션 버튼들
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-edit';
            editBtn.textContent = '수정';
            editBtn.onclick = () => showEditAnimalForm(animalName);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-danger';
            deleteBtn.textContent = '삭제';
            deleteBtn.onclick = () => deleteAnimal(animalName);
            
            headerDiv.appendChild(editBtn);
            headerDiv.appendChild(deleteBtn);
            
            infoDiv.appendChild(headerDiv);
            
            // 모든 카테고리를 체크박스 형태로 표시
            const categoriesDiv = document.createElement('div');
            categoriesDiv.className = 'animal-categories';
            
            // 모든 카테고리를 순서대로 표시
            const categoryOrder = [
                'MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN',
                'AQUATIC', 'MARINE', 'FRESHWATER', 'AERIAL',
                'DOMESTIC', 'PET', 'WILD',
                'ZODIAC', 'MYTHOLOGY', 'IMAGINARY', 'PREHISTORIC'
            ];
            
            categoryOrder.forEach(category => {
                if (CATEGORIES[category]) {
                    const checkDiv = document.createElement('div');
                    checkDiv.className = 'category-check' + (animalData[category] ? ' checked' : '');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = animalData[category] || false;
                    checkbox.disabled = true;
                    
                    const label = document.createElement('span');
                    label.textContent = CATEGORIES[category];
                    
                    checkDiv.appendChild(checkbox);
                    checkDiv.appendChild(label);
                    categoriesDiv.appendChild(checkDiv);
                }
            });
            
            infoDiv.appendChild(categoriesDiv);
            
            div.appendChild(infoDiv);
            
            return div;
        }
        
        // 동물 검색
        function searchAnimals() {
            displayAllAnimals();
        }
        
        // 데이터베이스 내보내기 (추가 기능)
        function exportDatabase() {
            const dataStr = JSON.stringify(ANIMAL_CATEGORIES, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'animal-database.json';
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // 데이터베이스 가져오기 (추가 기능)
        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (confirm('기존 데이터베이스를 덮어쓰시겠습니까?')) {
                                Object.assign(ANIMAL_CATEGORIES, data);
                                updateDatabaseStats();
                                displayAllAnimals();
                                alert('데이터베이스를 성공적으로 가져왔습니다.');
                            }
                        } catch (error) {
                            alert('파일을 읽는 중 오류가 발생했습니다.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // =====================================================
        // CSV 일괄 처리 기능
        // =====================================================
        
        // CSV 업로드 섹션 표시
        function showCSVUpload() {
            document.getElementById('csvUploadSection').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.querySelector('.database-management').style.display = 'none';
        }
        
        // CSV 업로드 섹션 숨기기
        function hideCSVUpload() {
            document.getElementById('csvUploadSection').style.display = 'none';
        }
        
        // CSV 템플릿 다운로드
        function downloadCSVTemplate() {
            const template = 'ID,성별,연령,학력,0-15초,15-30초,30-45초,45-60초\n' +
                           '001,남성,65,12,"개,고양이,소,말,돼지","닭,호랑이,사자,뱀,거북이","토끼,쥐,원숭이,양,염소","오리,거위,비둘기,참새,독수리"\n' +
                           '002,여성,72,6,"개,소,말,닭,오리","개구리,토끼,쥐,고양이,돼지","사자,호랑이,곰,여우,늑대","뱀,거북이,악어,도마뱀,개구리"\n' +
                           '샘플,남성,55,16,"개,고양이,소,말,돼지","닭,오리,거위,비둘기,참새","호랑이,사자,곰,늑대,여우","뱀,거북이,악어,도마뱀,개구리"';
            
            const blob = new Blob(['\ufeff' + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '동물유창성검사_템플릿.csv';
            link.click();
        }
        
        // CSV 파일 처리
        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSV 파일을 선택해주세요.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const rows = parseCSV(csv);
                    
                    if (rows.length < 2) {
                        alert('데이터가 없습니다.');
                        return;
                    }
                    
                    // 헤더 확인
                    const header = rows[0];
                    if (!validateHeader(header)) {
                        alert('CSV 헤더 형식이 올바르지 않습니다.');
                        return;
                    }
                    
                    // 각 행 처리
                    const results = [];
                    for (let i = 1; i < rows.length; i++) {
                        if (rows[i].length >= 8) {
                            const result = processRow(rows[i], i);
                            results.push(result);
                        }
                    }
                    
                    // 결과 표시
                    displayCSVResults(results);
                    
                } catch (error) {
                    console.error('CSV 처리 오류:', error);
                    alert('CSV 파일 처리 중 오류가 발생했습니다: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // CSV 파싱 - 따옴표로 묶인 셀을 올바르게 처리
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const rows = [];
            
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let cell = '';
                    let insideQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            row.push(cell.trim());
                            cell = '';
                        } else {
                            cell += char;
                        }
                    }
                    
                    // 마지막 셀 추가
                    row.push(cell.trim());
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // 헤더 검증
        function validateHeader(header) {
            const expected = ['ID', '성별', '연령', '학력', '0-15초', '15-30초', '30-45초', '45-60초'];
            return header.length >= 8 && 
                   header[0] === expected[0] &&
                   header[1] === expected[1] &&
                   header[2] === expected[2] &&
                   header[3] === expected[3];
        }
        
        // 개별 행 처리
        function processRow(row, rowIndex) {
            const id = row[0];
            const gender = row[1];
            const age = parseInt(row[2]) || 0;
            const education = parseInt(row[3]) || 0;
            
            // 각 시간대별 반응 파싱
            const responses = {
                '0-15': parseAnimals(row[4]),
                '15-30': parseAnimals(row[5]),
                '30-45': parseAnimals(row[6]),
                '45-60': parseAnimals(row[7])
            };
            
            // 점수 계산 (기존 calculateScores 로직 활용)
            const scores = calculateScoresForCSV({
                id: id,
                gender: gender,
                age: age,
                education: education,
                responses: responses
            });
            
            return {
                row: rowIndex + 1,
                id: id,
                gender: gender,
                age: age,
                education: education,
                ...scores
            };
        }
        
        // 동물 이름 파싱
        function parseAnimals(animalsStr) {
            if (!animalsStr) return [];
            return animalsStr.split(',').map(a => a.trim()).filter(a => a);
        }
        
        // CSV용 점수 계산
        function calculateScoresForCSV(data) {
            // 전역 responses 객체 임시 백업
            const backup = JSON.parse(JSON.stringify(responses));
            
            // CSV 데이터로 responses 설정
            responses['0-15'] = data.responses['0-15'];
            responses['15-30'] = data.responses['15-30'];
            responses['30-45'] = data.responses['30-45'];
            responses['45-60'] = data.responses['45-60'];
            
            // 모든 반응을 순서대로 정리
            const allResponses = [];
            let order = 1;
            
            ['0-15', '15-30', '30-45', '45-60'].forEach(range => {
                data.responses[range].forEach(response => {
                    const trimmed = response.trim();
                    const normalized = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(trimmed) : null;
                    const finalNormalized = normalized || (ANIMAL_CATEGORIES[trimmed] ? trimmed : null);
                    
                    allResponses.push({
                        response: response,
                        normalizedResponse: finalNormalized,
                        originalResponse: trimmed,
                        order,
                        timeRange: range
                    });
                    order++;
                });
            });
            
            // 점수 계산 로직 (기존 calculateScores 함수의 로직 재사용)
            const validResponses = allResponses.filter(r => r.normalizedResponse !== null);
            const uniqueResponses = [...new Set(validResponses.map(r => r.normalizedResponse))];
            const totalScore = uniqueResponses.length;
            
            const firstHalfResponses = allResponses.filter(r => 
                (r.timeRange === '0-15' || r.timeRange === '15-30') && r.normalizedResponse !== null
            );
            const firstHalfScore = new Set(firstHalfResponses.map(r => r.normalizedResponse)).size;
            
            const secondHalfResponses = allResponses.filter(r => 
                (r.timeRange === '30-45' || r.timeRange === '45-60') && r.normalizedResponse !== null
            );
            const secondHalfScore = new Set(secondHalfResponses.map(r => r.normalizedResponse)).size;
            
            const responseCount = {};
            validResponses.forEach(r => {
                responseCount[r.normalizedResponse] = (responseCount[r.normalizedResponse] || 0) + 1;
            });
            const perseverationScore = Object.values(responseCount)
                .filter(count => count > 1)
                .reduce((sum, count) => sum + (count - 1), 0);
            
            let intrusionScore = 0;
            allResponses.forEach(response => {
                if (response.normalizedResponse === null) {
                    intrusionScore++;
                }
            });
            
            const { transitions, clusters, switchingScore } = analyzeTransitionsAndClusters(validResponses);
            
            const usedCategories = new Set();
            clusters.forEach(cluster => {
                if (cluster.sharedCategories.length > 0) {
                    usedCategories.add(cluster.sharedCategories[0]);
                }
            });
            const categoryScore = usedCategories.size;
            
            const clusterSizes = clusters.map(c => c.size);
            const avgClusterSize = clusterSizes.length > 0 
                ? clusterSizes.reduce((sum, size) => sum + size, 0) / clusterSizes.length
                : 0;
            const maxClusterSize = Math.max(...clusterSizes, 0);
            
            const inefficientSwitchingScore = clusters.filter(c => c.size === 1).length;
            
            // 전역 responses 복원
            Object.assign(responses, backup);
            
            return {
                totalScore,
                firstHalfScore,
                secondHalfScore,
                perseverationScore,
                intrusionScore,
                switchingScore,
                inefficientSwitchingScore,
                categoryScore,
                avgClusterSize: avgClusterSize.toFixed(1),
                maxClusterSize
            };
        }
        
        // CSV 결과 표시
        function displayCSVResults(results) {
            let html = '<h3>처리 결과</h3>';
            html += '<table class="csv-result-table">';
            html += '<thead><tr>';
            html += '<th>번호</th><th>ID</th><th>성별</th><th>연령</th><th>학력</th>';
            html += '<th>총점</th><th>전반</th><th>후반</th><th>보속</th><th>침투</th>';
            html += '<th>전환</th><th>비효율</th><th>범주수</th><th>평균크기</th><th>최대크기</th>';
            html += '</tr></thead><tbody>';
            
            results.forEach(r => {
                html += '<tr>';
                html += `<td>${r.row}</td>`;
                html += `<td>${r.id}</td>`;
                html += `<td>${r.gender}</td>`;
                html += `<td>${r.age}</td>`;
                html += `<td>${r.education}</td>`;
                html += `<td>${r.totalScore}</td>`;
                html += `<td>${r.firstHalfScore}</td>`;
                html += `<td>${r.secondHalfScore}</td>`;
                html += `<td>${r.perseverationScore}</td>`;
                html += `<td>${r.intrusionScore}</td>`;
                html += `<td>${r.switchingScore}</td>`;
                html += `<td>${r.inefficientSwitchingScore}</td>`;
                html += `<td>${r.categoryScore}</td>`;
                html += `<td>${r.avgClusterSize}</td>`;
                html += `<td>${r.maxClusterSize}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // 결과 다운로드 버튼
            html += '<div style="margin-top: 20px;">';
            html += '<button onclick="downloadCSVResults(' + JSON.stringify(results).replace(/"/g, '&quot;') + ')" class="btn-primary">결과 다운로드</button>';
            html += '</div>';
            
            document.getElementById('csvResults').innerHTML = html;
        }
        
        // CSV 결과 다운로드
        function downloadCSVResults(results) {
            let csv = 'ID,성별,연령,학력,총점,전반점수,후반점수,보속,침투,전환,비효율전환,범주수,평균범주크기,최대범주크기\n';
            
            results.forEach(r => {
                csv += `${r.id},${r.gender},${r.age},${r.education},`;
                csv += `${r.totalScore},${r.firstHalfScore},${r.secondHalfScore},`;
                csv += `${r.perseverationScore},${r.intrusionScore},${r.switchingScore},`;
                csv += `${r.inefficientSwitchingScore},${r.categoryScore},`;
                csv += `${r.avgClusterSize},${r.maxClusterSize}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '동물유창성검사_결과_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }
    </script>
</body>
</html>